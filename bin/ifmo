#!/usr/bin/env node

/**
 * dependencies 
 */

var cli = require('clii')
  , exec = require('child_process').exec
  , ulog = require('util').log
  , ifmod = require('../');

var growl
  , use_growl;

try {
  growl = require('growl');
} catch (e) {
  // no growl support
}

function log (msg) {
  
  ulog( msg );
  
  if ( use_growl ) {
    if ( !growl ) {
      console.log('need growl support!\n\n  npm install -g growl');
      return;
    } else {
      growl.notify( msg );
    }
  }
  
}

cli( 'ifmod' )
  .v( ifmod.VERSION )
  .opt( "-c, --command <cmd>  the command that is executed when a change is found" )
  .opt( "-d, --directory <dir>  the directory of files you'd like to watch" )
  .opt( "-r, --recursive  watches for all files in sub-directories" )
  .opt( "-g, --growl  enables growl support ( npm install -g growl )" )
  .opt( "--verbose  output all the things!" )
  .run( function (opts, args) {
    
    var files;
    
    use_growl = opts.growl ? true : false;
    
    if ( !opts.directory ) {
      console.log('\n  Please specifiy: -d, --directory <dir>\n');
    } else {
      files = ifmod.find( opts.directory, { recursive: opts.recursive } );
    }
    
    if ( files ) {
    
      if ( opts.verbose ) {
        var msg = [ "" ];
        
        log("watching files:");
        
        files.forEach(function(f){
          msg.push( ["    ", f].join('') );
        });
    
        msg.push('');
        console.log( msg.join('\n') );
      }
  
      files.forEach( function ( file ) { 
        
        var ifModified = !opts.command ? function () {
          
          return log( ['modified:', file].join(' ') );
          
        } : function () {
          
          if ( opts.verbose ) {
            log( ['changed found in:', file].join(' ') );
            log( ['running:', opts.command].join(' ') );
          }
          
          if ( opts.command ) {
            exec( opts.command, function (err, stdout, stderr) {
              if (err) throw err;
              if (stdout) console.log(stdout);
              if (stderr) console.log(stderr);
            });
          }
          
        };
        return ifmod.watch( file, ifModified );
      });
    }
  });
