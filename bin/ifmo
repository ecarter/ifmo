#!/usr/bin/env node

/**
 * dependencies 
 */

var cli = require('clii')
  , exec = require('child_process').exec
  , log = require('util').log
  , ifmod = require('../');

cli('ifmod')
  .v(ifmod.VERSION)
  .opt("-c, --command <cmd>  the command that is executed when a change is found")
  .opt("-d, --directory <dir>  the directory of files you'd like to watch")
  .opt("-r, --recursive  watches for all files in sub-directories")
  .opt("-v, --verbose  output all the things!")
  .run( function (args) {
    var files;
    
    console.log('ifmo args:',args);
    
    if ( !args.directory || !(args.directory.length > 0) ) {
      console.log('\n  Please specifiy directory: -d, --directory\n');
    } else {
      files = ifmod.findFiles(args.directory, { recursive: args.recursive } );
    }

    if ( files ) {
  
      if ( args.verbose ) {
        var msg = [ "" ];
    
        log("watching files:");
    
        files.forEach(function(f){
          msg.push( ["    ", f].join('') );
        });
    
        msg.push('');
        console.log( msg.join('\n') );
      }
  
      files.forEach( function ( file ) { 
        
        var ifModified = !args.command ? function () {
          
          return log( ['modified:', file].join(' ') );
          
        } : function () {
          
          if ( args.verbose ) {
            log( ['changed found in:', file].join(' ') );
            log( ['running:', args.command].join(' ') );
          }
          
          
          exec(args.command, function (err, stdout, stderr) {
            if (err) throw err;
            if (stdout) console.log(stdout);
            if (stderr) console.log(stderr);
          });
          
        };
        return ifmod.watchFile( file, ifModified );
      });
    }
  });
